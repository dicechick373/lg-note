{"pageProps":{"post":{"title":"GoogleCloudFunctionsでsitemap.xmlを作成してCloudStorageに保存する","date":"2022-10-01","slug":"test","content":"<p>https://stitches.dev/</p>\n<h1 id=\"目標\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#目標\"><span class=\"icon icon-link\"></span></a>目標</h1>\n<ul>\n<li>GCFでsitemap.xmlを作成する</li>\n<li>GCSに保存する</li>\n</ul>\n<h1 id=\"コード\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#コード\"><span class=\"icon icon-link\"></span></a>コード</h1>\n<h2 id=\"mainpy\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#mainpy\"><span class=\"icon icon-link\"></span></a>main.py</h2>\n<pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> xml<span class=\"token punctuation\">.</span>etree<span class=\"token punctuation\">.</span>ElementTree <span class=\"token keyword\">as</span> ET\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>request\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> tempfile\n<span class=\"token keyword\">from</span> google<span class=\"token punctuation\">.</span>cloud <span class=\"token keyword\">import</span> storage\nstorage_client <span class=\"token operator\">=</span> storage<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    urlset <span class=\"token operator\">=</span> ET<span class=\"token punctuation\">.</span>Element<span class=\"token punctuation\">(</span><span class=\"token string\">'urlset'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.sitemaps.org/schemas/sitemap/0.9'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns:news'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.google.com/schemas/sitemap-news/0.9'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns:xhtml'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.w3.org/1999/xhtml'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns:mobile'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.google.com/schemas/sitemap-mobile/1.0'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns:image'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.google.com/schemas/sitemap-image/1.1'</span><span class=\"token punctuation\">)</span>\n    urlset<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmlns:video'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.google.com/schemas/sitemap-video/1.1'</span><span class=\"token punctuation\">)</span>\n    tree <span class=\"token operator\">=</span> ET<span class=\"token punctuation\">.</span>ElementTree<span class=\"token punctuation\">(</span>element<span class=\"token operator\">=</span>urlset<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 動的ルートのリスト設定</span>\n    routes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span> route <span class=\"token keyword\">in</span> routes<span class=\"token punctuation\">:</span>\n        url <span class=\"token operator\">=</span> <span class=\"token string\">'https://statistics-hyogo.com'</span><span class=\"token operator\">+</span>route\n        updated <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">.</span>today<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        updated <span class=\"token operator\">=</span> updated<span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%Y-%m-%d'</span><span class=\"token punctuation\">)</span>\n        url_element <span class=\"token operator\">=</span> ET<span class=\"token punctuation\">.</span>SubElement<span class=\"token punctuation\">(</span>urlset<span class=\"token punctuation\">,</span> <span class=\"token string\">'url'</span><span class=\"token punctuation\">)</span>\n        loc <span class=\"token operator\">=</span> ET<span class=\"token punctuation\">.</span>SubElement<span class=\"token punctuation\">(</span>url_element<span class=\"token punctuation\">,</span> <span class=\"token string\">'loc'</span><span class=\"token punctuation\">)</span>\n        loc<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> url\n        lastmod <span class=\"token operator\">=</span> ET<span class=\"token punctuation\">.</span>SubElement<span class=\"token punctuation\">(</span>url_element<span class=\"token punctuation\">,</span> <span class=\"token string\">'lastmod'</span><span class=\"token punctuation\">)</span>\n        lastmod<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> updated\n        \n    _<span class=\"token punctuation\">,</span> temp_local_filename <span class=\"token operator\">=</span> tempfile<span class=\"token punctuation\">.</span>mkstemp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    tree<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>temp_local_filename<span class=\"token punctuation\">,</span> encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">,</span> xml_declaration<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n        \n        \n    bucket <span class=\"token operator\">=</span> storage_client<span class=\"token punctuation\">.</span>bucket<span class=\"token punctuation\">(</span><span class=\"token string\">'statistics-hyogo'</span><span class=\"token punctuation\">)</span>\n    blob <span class=\"token operator\">=</span> bucket<span class=\"token punctuation\">.</span>blob<span class=\"token punctuation\">(</span><span class=\"token string\">'sitemap.xml'</span><span class=\"token punctuation\">)</span>\n    blob<span class=\"token punctuation\">.</span>upload_from_filename<span class=\"token punctuation\">(</span>temp_local_filename<span class=\"token punctuation\">)</span>\n    os<span class=\"token punctuation\">.</span>remove<span class=\"token punctuation\">(</span>temp_local_filename<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'sitemap.xml generated !!'</span>\n\n</code></pre>\n<h2 id=\"requirementstxt\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#requirementstxt\"><span class=\"icon icon-link\"></span></a>requirements.txt</h2>\n<pre class=\"language-txt\"><code class=\"language-txt\">google-cloud-storage==1.23.0\n</code></pre>","ogImage":{"url":"/assets/blog/dynamic-routing/cover.jpg"},"coverImage":"/assets/blog/dynamic-routing/cover.jpg","tags":["Python","GCF","GCS"]}},"__N_SSG":true}